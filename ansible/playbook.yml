- name: Install and configure WireGuard VPN
  hosts: vpn_hosts
  become: true
  vars:
    wg_interface: "wg0"
    wg_port: 51820
    private_key: "{{ lookup('env','WG_PRIVATE_KEY') | default('GENERATE_ON_HOST', true) }}"
    peer_public_key: "REPLACE_WITH_PEER_PUBLIC_KEY"
    peer_endpoint: "peer.example.com:51820"
    allowed_ips: "0.0.0.0/0"
  tasks:
    - name: Ensure required packages present (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - wireguard
          - wireguard-tools
        update_cache: yes
      when: ansible_facts['os_family'] == 'Debian'

    - name: Ensure required packages present (RedHat/CentOS)
      ansible.builtin.yum:
        name:
          - epel-release
        state: present
      when: ansible_facts['os_family'] == 'RedHat'

    - name: Install WireGuard on RedHat-based systems
      ansible.builtin.yum:
        name: wireguard-tools
        state: present
      when: ansible_facts['os_family'] == 'RedHat'

    - name: Create /etc/wireguard
      ansible.builtin.file:
        path: /etc/wireguard
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Deploy WireGuard config
      ansible.builtin.template:
        src: templates/wg0.conf.j2
        dest: /etc/wireguard/{{ wg_interface }}.conf
        owner: root
        group: root
        mode: '0600'

    - name: Enable and start WireGuard
      ansible.builtin.systemd:
        name: wg-quick@{{ wg_interface }}
        enabled: yes
        state: started
        daemon_reload: yes
